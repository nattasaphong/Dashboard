<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö/‡∏™‡πà‡∏á‡∏ú‡πâ‡∏≤</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Prompt", sans-serif;
      background: #fff;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }
    .card {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .big {
      font-size: 28px;
      font-weight: bold;
      margin-top: 10px;
    }
    .content {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #f1f3f4;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <h1>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö/‡∏™‡πà‡∏á‡∏ú‡πâ‡∏≤</h1>

  <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ -->
  <div class="dashboard">
    <div class="card">
      <div>‡∏£‡∏ß‡∏°‡∏£‡∏±‡∏ö</div>
      <div class="big" id="sumIn">0</div>
    </div>
    <div class="card">
      <div>‡∏£‡∏ß‡∏°‡∏™‡πà‡∏á</div>
      <div class="big" id="sumOut">0</div>
    </div>
    <div class="card">
      <div>‡∏Ñ‡πâ‡∏≤‡∏á</div>
      <div class="big" id="pending">0</div>
    </div>
    <div class="card">
      <div>‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ñ‡πâ‡∏≤‡∏á</div>
      <div class="big" id="percentPending">0%</div>
    </div>
  </div>

  <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á + ‡∏Å‡∏£‡∏≤‡∏ü -->
  <div class="content">
    <div>
      <table>
        <thead>
          <tr>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°</th>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
            <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πâ‡∏≤</th>
          </tr>
        </thead>
        <tbody id="dataTable"></tbody>
      </table>
    </div>
    <div>
      <canvas id="barChart" height="150"></canvas>
      <canvas id="pieChart" height="150"></canvas>
    </div>
  </div>

  <script>
    // üëâ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡πá‡∏ö‡∏ä‡∏µ‡∏ó‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÄ‡∏ä‡πà‡∏ô &sheet=‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î ‡∏ß‡∏≤‡∏á‡∏ö‡∏¥‡∏•
    const sheetURL = "https://docs.google.com/spreadsheets/d/1GRuJTxE_uV9Lpq47pg7tywmKBAzh7_pV6x9JBk3FtXc/gviz/tq?tqx=out:json&sheet=Sheet1";

    let barChart, pieChart;

    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å Google Sheet
    function parseThaiDate(cell) {
      if (!cell) return null;

      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡πÅ‡∏ö‡∏ö formatted (f) ‡πÄ‡∏ä‡πà‡∏ô "16/06/2568"
      if (cell.f) {
        const parts = cell.f.split("/");
        if (parts.length === 3) {
          let day = parseInt(parts[0]);
          let month = parseInt(parts[1]) - 1;
          let year = parseInt(parts[2]);
          if (year > 2400) year -= 543; // ‡πÅ‡∏õ‡∏•‡∏á ‡∏û.‡∏®. -> ‡∏Ñ.‡∏®.
          return new Date(year, month, day);
        }
      }

      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡πÅ‡∏ö‡∏ö serial number ‡πÄ‡∏ä‡πà‡∏ô 45567
      if (cell.v && !isNaN(cell.v)) {
        const baseDate = new Date(1899, 11, 30); // Excel/Sheets serial base
        return new Date(baseDate.getTime() + cell.v * 24 * 60 * 60 * 1000);
      }

      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô string ISO ‡πÄ‡∏ä‡πà‡∏ô "2025-09-18"
      return new Date(cell.v);
    }

    async function fetchData() {
      try {
        const res = await fetch(sheetURL);
        let text = await res.text();
        text = text.substring(47, text.length - 2); // ‡∏ï‡∏±‡∏î wrapper ‡∏Ç‡∏≠‡∏á Google ‡∏≠‡∏≠‡∏Å
        const json = JSON.parse(text);
        const rows = json.table.rows;

        let sumIn = 0, sumOut = 0;
        let hotels = {};

        rows.forEach(r => {
          let hotel = r.c[0]?.v || "";
          let date = parseThaiDate(r.c[1]);
          let item = r.c[2]?.v || "";
          let qty = r.c[3]?.v || 0;
          let type = r.c[4]?.v || "";

          if (type === "‡∏£‡∏±‡∏ö") sumIn += qty;
          if (type === "‡∏™‡πà‡∏á") sumOut += qty;

          let dateStr = date ? date.toLocaleDateString("th-TH") : "";
          let key = hotel + "|" + dateStr;
          if (!hotels[key]) hotels[key] = {hotel, dateStr, items: []};
          hotels[key].items.push(`${item} (${qty})`);
        });

        // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πâ‡∏≤‡∏á = ‡∏£‡∏ß‡∏°‡∏£‡∏±‡∏ö - ‡∏£‡∏ß‡∏°‡∏™‡πà‡∏á
        let pending = sumIn - sumOut;

        // update ‡∏Å‡∏≤‡∏£‡πå‡∏î
        document.getElementById("sumIn").innerText = sumIn;
        document.getElementById("sumOut").innerText = sumOut;
        document.getElementById("pending").innerText = pending;
        let percent = sumIn ? Math.round((pending / sumIn) * 100) : 0;
        document.getElementById("percentPending").innerText = percent + "%";

        // update ‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        let table = document.getElementById("dataTable");
        table.innerHTML = "";
        Object.values(hotels).forEach(it => {
          table.innerHTML += `
            <tr>
              <td>${it.hotel}</td>
              <td>${it.dateStr}</td>
              <td>${it.items.join("<br>")}</td>
            </tr>`;
        });

        // update ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á
        if (barChart) barChart.destroy();
        barChart = new Chart(document.getElementById("barChart"), {
          type: "bar",
          data: {
            labels: ["‡∏£‡∏ß‡∏°‡∏£‡∏±‡∏ö", "‡∏£‡∏ß‡∏°‡∏™‡πà‡∏á"],
            datasets: [{
              data: [sumIn, sumOut],
              backgroundColor: ["#4caf50", "#2196f3"]
            }]
          }
        });

        // update ‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏°
        if (pieChart) pieChart.destroy();
        pieChart = new Chart(document.getElementById("pieChart"), {
          type: "doughnut",
          data: {
            labels: ["‡∏Ñ‡πâ‡∏≤‡∏á", "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"],
            datasets: [{
              data: [pending, sumIn - pending],
              backgroundColor: ["#e74c3c", "#95a5a6"]
            }]
          }
        });

      } catch (err) {
        console.error("Error:", err);
      }
    }

    fetchData();
    setInterval(fetchData, 60000); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏∏‡∏Å 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  </script>
</body>
</html>
