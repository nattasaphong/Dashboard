<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>แดชบอร์ด รับ-ส่งผ้า</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #fafafa; color: #333; }
    h1 { margin-bottom: 20px; }
    .cards { display: flex; gap: 20px; margin-bottom: 20px; }
    .card { flex: 1; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); text-align: center; }
    .card h2 { margin: 0; font-size: 24px; color: #007bff; }
    .card p { margin: 5px 0 0; color: #555; }
    .charts { display: flex; gap: 20px; margin-bottom: 20px; }
    #barChart, #gaugeChart { flex: 1; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    table { border-collapse: collapse; width: 100%; background: white; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); overflow: hidden; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; text-align: left; vertical-align: top; }
    th { background: #f5f5f5; font-weight: bold; }
  </style>
  <script>
    google.charts.load('current', {'packages':['corechart','gauge']});

    // ฟังก์ชันแปลงวันที่ไทย (พ.ศ. -> ค.ศ.)
    function parseThaiDate(str) {
      if (!str) return null;
      const parts = str.split("/");
      if (parts.length === 3) {
        let day = parseInt(parts[0]);
        let month = parseInt(parts[1]) - 1; // JS month เริ่มที่ 0
        let year = parseInt(parts[2]);
        if (year > 2400) { // ถ้าเป็น พ.ศ.
          year -= 543;
        }
        return new Date(year, month, day);
      }
      return new Date(str); // fallback
    }

    async function fetchSheetData() {
      const sheetId = "1GRuJTxE_uV9Lpq47pg7tywmKBAzh7_pV6x9JBk3FtXc";
      const sheetName = "Dashboard รายการผ้า";
      const query = encodeURIComponent("SELECT A,B,C,D,E");  
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tq=${query}&tqx=out:json`;

      const resp = await fetch(url);
      const text = await resp.text();
      const jsonText = text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1);
      const data = JSON.parse(jsonText);
      return data.table;
    }

    function processData(table) {
      const rows = table.rows;
      let totalReceive = 0;
      let totalSend = 0;

      // Group by โรงแรม + วันที่
      const grouped = {};

      rows.forEach(r => {
        const hotel = r.c[0] && r.c[0].v;
        const dateRaw = r.c[1] && (r.c[1].f || r.c[1].v);
        const item = r.c[2] && r.c[2].v;
        const qty = r.c[3] && r.c[3].v;
        const type = r.c[4] && r.c[4].v;

        if (!hotel || !dateRaw || !item || qty == null || !type) return;

        const date = parseThaiDate(dateRaw);
        const dateStr = date.toLocaleDateString('th-TH', { year:'numeric', month:'short', day:'numeric' });

        const key = hotel + "|" + dateStr;
        if (!grouped[key]) {
          grouped[key] = { hotel, date: dateStr, items: [] };
        }
        grouped[key].items.push(`${item} (${qty})`);

        if (type === "รับ") totalReceive += qty;
        if (type === "ส่ง") totalSend += qty;
      });

      const items = Object.values(grouped);
      const pending = totalReceive - totalSend;

      return { totalReceive, totalSend, pending, items };
    }

    function drawCharts(stats) {
      document.getElementById('totalReceive').innerText = stats.totalReceive;
      document.getElementById('totalSend').innerText = stats.totalSend;
      document.getElementById('pending').innerText = stats.pending;

      // Bar chart รับ vs ส่ง
      const barData = google.visualization.arrayToDataTable([
        ['ประเภท','จำนวน'],
        ['รับ', stats.totalReceive],
        ['ส่ง', stats.totalSend]
      ]);
      const barChart = new google.visualization.ColumnChart(document.getElementById('barChart'));
      barChart.draw(barData, {legend:{position:'none'}, height: 300});

      // Gauge chart
      const gaugeData = google.visualization.arrayToDataTable([
        ['Label','Value'],
        ['ค้าง', stats.pending]
      ]);
      const gaugeChart = new google.visualization.Gauge(document.getElementById('gaugeChart'));
      gaugeChart.draw(gaugeData, {width:200, height:200, redFrom:50, redTo:100, yellowFrom:20, yellowTo:50, minorTicks:5});
    }

    async function initDashboard() {
      const table = await fetchSheetData();
      const stats = processData(table);
      drawCharts(stats);

      // สร้างตารางแสดงรายการ
      let html = `<tr><th>โรงแรม</th><th>วันที่</th><th>รายการผ้า</th></tr>`;
      stats.items.forEach(it => {
        html += `<tr>
          <td>${it.hotel}</td>
          <td>${it.date}</td>
          <td>${it.items.join("<br>")}</td>
        </tr>`;
      });
      document.getElementById('itemsTable').innerHTML = html;
    }

    window.onload = function(){
      google.charts.setOnLoadCallback(initDashboard);
    }
  </script>
</head>
<body>
  <h1>แดชบอร์ด รับ-ส่งผ้า</h1>
  <div class="cards">
    <div class="card"><h2 id="totalReceive">0</h2><p>รวมรับ</p></div>
    <div class="card"><h2 id="totalSend">0</h2><p>รวมส่ง</p></div>
    <div class="card"><h2 id="pending">0</h2><p>ค้าง</p></div>
  </div>
  <div class="charts">
    <div id="barChart"></div>
    <div id="gaugeChart"></div>
  </div>
  <table id="itemsTable"></table>
</body>
</html>
